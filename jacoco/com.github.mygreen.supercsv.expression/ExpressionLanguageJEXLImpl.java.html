<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ja"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ExpressionLanguageJEXLImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Super CSV Annotation</a> &gt; <a href="index.source.html" class="el_package">com.github.mygreen.supercsv.expression</a> &gt; <span class="el_source">ExpressionLanguageJEXLImpl.java</span></div><h1>ExpressionLanguageJEXLImpl.java</h1><pre class="source lang-java linenums">package com.github.mygreen.supercsv.expression;

import java.util.Arrays;
import java.util.Collections;
import java.util.HashMap;
import java.util.Map;
import java.util.Objects;
import java.util.stream.Collectors;

import org.apache.commons.jexl3.JexlBuilder;
import org.apache.commons.jexl3.JexlEngine;
import org.apache.commons.jexl3.JexlExpression;
import org.apache.commons.jexl3.MapContext;
import org.apache.commons.jexl3.introspection.JexlPermissions;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.github.mygreen.supercsv.util.Utils;


/**
 * 式言語&lt;a href=&quot;http://commons.apache.org/proper/commons-jexl/&quot; target=&quot;_blank&quot;&gt;JEXL(Java Expression Language)&lt;/a&gt;の実装。
 * &lt;p&gt;利用する際には、JEXL v3.3以上のライブラリが必要です。
 * &lt;p&gt;JEXL v3.3から、ELインジェクション対策として、&lt;a href=&quot;https://commons.apache.org/proper/commons-jexl/apidocs/org/apache/commons/jexl3/introspection/JexlPermissions.html)&quot;&gt;JexlPermissions&lt;/a&gt;によるEL式中で参照／実行可能なクラスを制限されます。
 * &lt;p&gt;独自のCellProcessorなどを実装しているが場合は、システムプロパティ {@literal supercsv.annotation.jexlPermissions} で指定することができます。
 *    複数指定する場合はカンマ区切りで指定します。
 * &lt;/p&gt;
 *
 * @version 2.4
 * @since 2.0
 * @author T.TSUCHIE
 *
 */
public class ExpressionLanguageJEXLImpl implements ExpressionLanguage {
    
<span class="fc" id="L36">    private static final Logger logger = LoggerFactory.getLogger(ExpressionLanguageJEXLImpl.class);</span>
    
    /**
     * システムプロパティ - JEXLをRESTRICTモードで使用するかどうかフラグ。
     */
    public static final String PROPERTY_JEXL_RESTRICTED = &quot;supercsv.annotation.jexlRestricted&quot;;
    
    /**
     * システムプロパティ - JEXLをRESTRICTモードで使用する場合のパーミッションを指定する
     */
<span class="fc" id="L46">    protected static final String[] LIB_PERMISSIONS = {&quot;com.github.mygreen.supercsv.*&quot;};</span>
    
    /**
     * 独自のJEXLのパーミッション。
     */
    protected static final String[] USER_PERMISSIONS;
    static {
<span class="fc" id="L53">        String value = System.getProperty(&quot;supercsv.annotation.jexlPermissions&quot;);</span>
<span class="pc bpc" id="L54" title="1 of 2 branches missed.">        if(Utils.isNotEmpty(value)) {</span>
<span class="nc" id="L55">            USER_PERMISSIONS = Arrays.stream(value.split(&quot;,&quot;))</span>
<span class="nc" id="L56">                    .map(String::trim)</span>
<span class="nc" id="L57">                    .filter(Utils::isNotEmpty)</span>
<span class="nc" id="L58">                    .collect(Collectors.toList())</span>
<span class="nc" id="L59">                    .toArray(new String[0]);</span>
            
        } else {
<span class="fc" id="L62">            USER_PERMISSIONS = new String[] {};</span>
        }
<span class="fc" id="L64">    }</span>
    
    /**
     * JEXLのキャッシュサイズ。
     * &lt;p&gt;キャッシュする式の個数。
     */
    private static final int CACHE_SIZE = 256;
    
    private final JexlEngine jexlEngine;
    
    /**
     * JEXLのパーミッションを指定するコンストラクタ。
     * &lt;p&gt;関数として{@link CustomFunctions}が登録されており、接頭語 {@literal f:}で呼び出し可能です。
     * 
     * @param userPermissions JEXLのパーミッション。
     *        詳細は、&lt;a href=&quot;https://commons.apache.org/proper/commons-jexl/apidocs/org/apache/commons/jexl3/introspection/JexlPermissions.html)&quot;&gt;JexlPermissions&lt;/a&gt; を参照。
     */
    public ExpressionLanguageJEXLImpl(final String... userPermissions) {
<span class="fc" id="L82">        this(Collections.emptyMap(), true, userPermissions);</span>
        
<span class="fc" id="L84">    }</span>
    
    /**
     * JEXLの独自のEL関数とパーミッションを指定するコンストラクタ。
     * &lt;p&gt;関数として{@link CustomFunctions}が登録されており、接頭語 {@literal f:}で呼び出し可能です。
     * 
     * @param userFunctions 独自のEL関数を指定します。keyは接頭語、valueはメソッドが定義されたクラス。
     * @param userPermissions JEXLのパーミッション。
     *        詳細は、&lt;a href=&quot;https://commons.apache.org/proper/commons-jexl/apidocs/org/apache/commons/jexl3/introspection/JexlPermissions.html)&quot;&gt;JexlPermissions&lt;/a&gt; を参照。
     */
<span class="fc" id="L94">    public ExpressionLanguageJEXLImpl(final Map&lt;String, Object&gt; userFunctions, final boolean restricted, final String... userPermissions) {</span>
        
<span class="fc" id="L96">        this.jexlEngine = new JexlBuilder()</span>
<span class="fc" id="L97">                .namespaces(buildNamespace(userFunctions))</span>
<span class="fc" id="L98">                .permissions(buildPermissions(restricted, userPermissions))</span>
<span class="fc" id="L99">                .silent(true)</span>
<span class="fc" id="L100">                .cache(CACHE_SIZE)</span>
<span class="fc" id="L101">                .create();</span>
<span class="fc" id="L102">    }</span>
    
    /**
     * {@link JexlEngine}を指定するコンストラクタ。
     * @param jexlEngine JEXLの処理エンジン。
     */
<span class="nc" id="L108">    public ExpressionLanguageJEXLImpl(final JexlEngine jexlEngine) {</span>
<span class="nc" id="L109">        this.jexlEngine = jexlEngine;</span>
<span class="nc" id="L110">    }</span>
    
    /**
     * EL関数の名前空間を組み立て、独自のEL関数を登録します。
     * 
     * @param userFunctions 独自のEL関数を指定します。keyは接頭語、valueはメソッドが定義されたクラス。
     * @return EL関数の名前空間
     */
    protected Map&lt;String, Object&gt; buildNamespace(final Map&lt;String, Object&gt; userFunctions) {
        
        // EL式中で使用可能な関数の登録
<span class="fc" id="L121">        Map&lt;String, Object&gt; functions = new HashMap&lt;&gt;();</span>
<span class="fc" id="L122">        functions.put(&quot;f&quot;, CustomFunctions.class);</span>
        
<span class="pc bpc" id="L124" title="1 of 2 branches missed.">        if (Utils.isNotEmpty(userFunctions)) {</span>
<span class="nc" id="L125">            functions.putAll(userFunctions);</span>
        }

        
<span class="fc" id="L129">        return functions;</span>
    }
    
    /**
     * JEXLのパーミッションを組み立てる。
     * 
     * @param userPermissions ユーザー指定のJEXLのパーミッション。
     *        詳細は、&lt;a href=&quot;https://commons.apache.org/proper/commons-jexl/apidocs/org/apache/commons/jexl3/introspection/JexlPermissions.html)&quot;&gt;JexlPermissions&lt;/a&gt; を参照。
     * @return JEXLのパーミッション
     */
    protected JexlPermissions buildPermissions(final boolean restricted, final String... userPermissions) {
        
        final JexlPermissions permissions;
<span class="pc bpc" id="L142" title="1 of 2 branches missed.">        if(Utils.toBoolean(System.getProperty(PROPERTY_JEXL_RESTRICTED), restricted)) {</span>
            /*
             * EL式で本ライブラリのクラス／メソッドのアクセスを許可する。
             * ・CustomFunctions以外にも、TextPrinterを実装している各CellProcessorでも参照するため。
             * ・JEXL3からサーバーサイド・テンプレート・インジェクション、コマンドインジェクション対策のために、
             *   許可されたクラスしか参照できなくなったため、本ライブラリをEL式から参照可能に許可する。
             */
<span class="fc" id="L149">            String[] concateedUserPermission = Utils.concat(USER_PERMISSIONS, userPermissions);</span>
<span class="fc" id="L150">            permissions = JexlPermissions.RESTRICTED</span>
<span class="fc" id="L151">                    .compose(Utils.concat(LIB_PERMISSIONS, concateedUserPermission));</span>
            
<span class="fc" id="L153">        } else {</span>
            // パーミッションによる制限を行わない。
<span class="nc" id="L155">            permissions = JexlPermissions.UNRESTRICTED;</span>
        }
        
<span class="fc" id="L158">        return permissions;</span>
    }
    
    @Override
    public Object evaluate(final String expression, final Map&lt;String, Object&gt; values) {
        
<span class="fc" id="L164">        Objects.requireNonNull(expression, &quot;expression shoud not be null.&quot;);</span>
<span class="fc" id="L165">        Objects.requireNonNull(values, &quot;values shoud not be null.&quot;);</span>
        
<span class="pc bpc" id="L167" title="1 of 2 branches missed.">        if(logger.isDebugEnabled()) {</span>
<span class="fc" id="L168">            logger.debug(&quot;Evaluating JEXL expression: {}&quot;, expression);</span>
        }
        
        try {
<span class="fc" id="L172">            JexlExpression expr = jexlEngine.createExpression(expression);</span>
<span class="fc" id="L173">            return expr.evaluate(new MapContext((Map&lt;String, Object&gt;) values));</span>
            
<span class="fc" id="L175">        } catch(Exception ex) {</span>
<span class="fc" id="L176">            throw new ExpressionEvaluationException(String.format(&quot;Evaluating [%s] script with JEXL failed.&quot;, expression), ex,</span>
                    expression, values);
        }
    }
    
    /**
     * {@link JexlEngine}を取得する。
     * @return
     */
    public JexlEngine getJexlEngine() {
<span class="nc" id="L186">        return jexlEngine;</span>
    }
    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>